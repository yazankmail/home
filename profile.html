<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap');
        
        :root {
            --bg-color: #FAFAFA; --card-bg: #FFFFFF;
            --text-main: #1D1D1D; --text-sub: #888888;
            --accent-color: #008489; /* Ù„ÙˆÙ† Ù…Ø´Ø§Ø¨Ù‡ Ù„Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ø£Ø®Ø¶Ø± Ø§Ù„Ù…Ø²Ø±Ù‚ */
            --border-color: #F0F0F0;
            --shadow: 0 5px 20px rgba(0,0,0,0.04);
        }

        body.dark-mode {
            --bg-color: #121212; --card-bg: #1E1E1E;
            --text-main: #FFFFFF; --text-sub: #AAAAAA;
            --border-color: #333;
        }

        * { box-sizing: border-box; transition: 0.3s; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Cairo', sans-serif; margin: 0; background: var(--bg-color); color: var(--text-main); padding-bottom: 90px; }

        .container { max-width: 500px; margin: 0 auto; padding: 20px; }

        /* Ø§Ù„Ù‡ÙŠØ¯Ø± */
        header { text-align: center; margin-top: 20px; margin-bottom: 30px; }
        .page-title { font-weight: 800; font-size: 20px; }

        /* Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ */
        .profile-header { text-align: center; margin-bottom: 40px; }
        .avatar-box { 
            position: relative; width: 100px; height: 100px; margin: 0 auto 15px; 
        }
        .profile-img { 
            width: 100%; height: 100%; border-radius: 50%; 
            object-fit: cover; border: 3px solid white; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.1); 
        }
        .edit-icon-badge {
            position: absolute; bottom: 0; right: 0;
            background: var(--accent-color); color: white;
            width: 30px; height: 30px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            border: 2px solid white; cursor: pointer;
        }
        .user-name { font-size: 22px; font-weight: 800; margin: 0; }
        .user-role { font-size: 14px; color: var(--text-sub); margin-top: 5px; }

        /* Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© */
        .menu-list { display: flex; flex-direction: column; gap: 15px; }
        .menu-item {
            background: var(--card-bg); padding: 15px 20px;
            border-radius: 15px; display: flex; align-items: center; justify-content: space-between;
            box-shadow: var(--shadow); cursor: pointer;
        }
        .item-left { display: flex; align-items: center; gap: 15px; }
        .item-icon { 
            width: 40px; height: 40px; border-radius: 10px; 
            background: rgba(0, 132, 137, 0.1); color: var(--accent-color);
            display: flex; align-items: center; justify-content: center;
        }
        .item-text { font-weight: 700; font-size: 15px; }
        
        .logout-btn {
            background: var(--accent-color); color: white;
            width: 100%; padding: 18px; border-radius: 15px;
            border: none; font-weight: bold; font-size: 16px;
            margin-top: 30px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px;
        }

        /* Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ (Full Screen Modal) */
        .edit-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-color); z-index: 2000;
            padding: 20px; overflow-y: auto;
            transform: translateY(100%); transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        .edit-modal.open { transform: translateY(0); }

        .modal-nav { display: flex; align-items: center; margin-bottom: 30px; }
        .back-btn { 
            width: 40px; height: 40px; background: var(--card-bg); 
            border-radius: 10px; display: flex; align-items: center; justify-content: center; 
            box-shadow: var(--shadow); cursor: pointer; 
        }

        .form-group { margin-bottom: 20px; }
        .label { display: block; font-size: 13px; font-weight: 700; color: var(--text-sub); margin-bottom: 8px; }
        .input-field {
            width: 100%; padding: 16px; border-radius: 12px;
            border: 1px solid var(--border-color); background: var(--card-bg);
            color: var(--text-main); font-family: 'Cairo'; font-weight: 600; font-size: 15px;
        }
        
        /* Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…ØºÙ„Ù‚Ø© */
        .input-field:disabled { background: #EFEFEF; color: #999; cursor: not-allowed; }
        .lock-note { font-size: 11px; color: #E53935; margin-top: 5px; }

        .save-btn {
            background: var(--accent-color); color: white; width: 100%; padding: 18px;
            border-radius: 50px; border: none; font-weight: bold; font-size: 16px;
            margin-top: 20px; cursor: pointer; box-shadow: 0 10px 20px rgba(0, 132, 137, 0.2);
        }

        /* ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¶ÙŠÙ */
        .guest-view { text-align: center; padding: 60px 20px; display: none; }
        .google-btn { 
            background: white; color: #333; padding: 12px 30px; 
            border-radius: 50px; font-weight: bold; border: 1px solid #ddd; 
            display: inline-flex; align-items: center; gap: 10px; cursor: pointer; 
            margin-top: 20px; box-shadow: var(--shadow);
        }

        /* Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø³ÙÙ„ÙŠ */
        .floating-nav { position: fixed; bottom: 20px; left: 20px; right: 20px; background: white; height: 70px; border-radius: 25px; display: flex; justify-content: space-around; align-items: center; box-shadow: 0 10px 40px rgba(0,0,0,0.1); z-index: 900; }
        .nav-link svg { width: 26px; height: 26px; stroke: #999; fill: none; stroke-width: 2; }
        .nav-link.active svg { stroke: var(--accent-color); }
        @media (min-width: 769px) { .floating-nav { display: none; } }
    </style>
</head>
<body>

    <div id="user-view" style="display: none;">
        <header><div class="page-title">Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</div></header>

        <div class="container">
            <div class="profile-header">
                <div class="avatar-box">
                    <img id="main-avatar" src="" class="profile-img">
                    <div class="edit-icon-badge" onclick="openEditModal()">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                    </div>
                </div>
                <h2 id="main-name" class="user-name">...</h2>
                <div class="user-role">Ø¹Ù…ÙŠÙ„ Ù…Ù…ÙŠØ²</div>
            </div>

            <div class="menu-list">
                <div class="menu-item" onclick="openEditModal()">
                    <div class="item-left">
                        <div class="item-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg></div>
                        <span class="item-text">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</span>
                    </div>
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#ccc" stroke-width="2"><polyline points="15 18 9 12 15 6"></polyline></svg>
                </div>

                <div class="menu-item">
                    <div class="item-left">
                        <div class="item-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg></div>
                        <span class="item-text">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø´Ø­Ù†</span>
                    </div>
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#ccc" stroke-width="2"><polyline points="15 18 9 12 15 6"></polyline></svg>
                </div>

                <div class="menu-item" onclick="alert('ØªÙˆØ§ØµÙ„ Ù…Ø¹Ù†Ø§: support@wusooly.com')">
                    <div class="item-left">
                        <div class="item-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="5" y="2" width="14" height="20" rx="2" ry="2"></rect><line x1="12" y1="18" x2="12.01" y2="18"></line></svg></div>
                        <span class="item-text">ØªØºÙŠÙŠØ± Ø§Ù„Ø±Ù‚Ù… / Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„</span>
                    </div>
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#ccc" stroke-width="2"><polyline points="15 18 9 12 15 6"></polyline></svg>
                </div>
            </div>

            <button class="logout-btn" id="logout-btn">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
        </div>
    </div>

    <div id="guest-view" class="guest-view">
        <span style="font-size:60px;">ğŸ”’</span>
        <h2>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ø·Ù„ÙˆØ¨</h2>
        <p style="color:var(--text-sub)">Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ù…Ù„ÙÙƒ Ø§Ù„Ø´Ø®ØµÙŠ</p>
        <button id="login-btn" class="google-btn">
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="20">
            Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Google
        </button>
    </div>

    <div id="edit-modal" class="edit-modal">
        <div class="container">
            <div class="modal-nav">
                <div class="back-btn" onclick="closeEditModal()">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"></polyline></svg>
                </div>
                <h3 style="flex-grow:1; text-align:center;">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h3>
                <div style="width:40px;"></div>
            </div>

            <div class="form-group">
                <label class="label">Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø£ÙˆÙ„</label>
                <input type="text" id="inp-fname" class="input-field" placeholder="Ù…Ø«Ù„Ø§Ù‹: Ù…Ø­Ù…Ø¯">
            </div>
            <div class="form-group">
                <label class="label">Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©</label>
                <input type="text" id="inp-sname" class="input-field" placeholder="Ù…Ø«Ù„Ø§Ù‹: Ø£Ø­Ù…Ø¯">
            </div>

            <div class="form-group">
                <label class="label">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
                <input type="text" id="inp-phone" class="input-field" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù…Ùƒ Ù„Ù„ØªÙˆØ§ØµÙ„">
                <div id="phone-lock-hint" class="lock-note" style="display:none;">ğŸ”’ Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØºÙŠÙŠØ± Ø§Ù„Ø±Ù‚Ù… Ø¥Ù„Ø§ Ø¨Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</div>
            </div>

            <div class="form-group">
                <label class="label">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
                <input type="email" id="inp-email" class="input-field" disabled>
                <div class="lock-note">ğŸ”’ Ù…Ø±ØªØ¨Ø· Ø¨Ø­Ø³Ø§Ø¨ Google</div>
            </div>

            <div class="form-group">
                <label class="label">Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</label>
                <input type="text" id="inp-city" class="input-field">
            </div>
            <div class="form-group">
                <label class="label">Ø§Ù„Ø´Ø§Ø±Ø¹</label>
                <input type="text" id="inp-street" class="input-field">
            </div>

            <button class="save-btn" onclick="saveData()">Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</button>
        </div>
    </div>

    <div class="floating-nav">
        <a href="index.html" class="nav-link"><svg viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg></a>
        <a href="cart.html" class="nav-link"><svg viewBox="0 0 24 24"><circle cx="9" cy="21" r="1"></circle><circle cx="20" cy="21" r="1"></circle><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path></svg></a>
        <a href="#" class="nav-link active"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg></a>
    </div>

    <script>
        if (localStorage.getItem('theme') === 'dark') document.body.classList.add('dark-mode');
    </script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signOut, onAuthStateChanged, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBa0RwEcbVqWYAKeUFeZy2IDihaxUxtNKY",
            authDomain: "wusooly-1906b.firebaseapp.com",
            projectId: "wusooly-1906b",
            storageBucket: "wusooly-1906b.firebasestorage.app",
            messagingSenderId: "95836343161",
            appId: "1:95836343161:web:73ae3faaca406c0bf7fda8",
            measurementId: "G-2704R4YR1M"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();
        
        let currentUser = null;

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                // Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¯ÙˆÙ† Ø¥Ø¸Ù‡Ø§Ø± Ø£Ø®Ø·Ø§Ø¡
                const userDoc = await getDoc(doc(db, "users", user.uid));
                
                if (userDoc.exists()) {
                    const data = userDoc.data();
                    showProfile(user, data);
                    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ø³Ø¬Ù„Ø§Ù‹ØŒ Ù†Ù‚ÙÙ„ Ø­Ù‚Ù„ Ø§Ù„Ù‡Ø§ØªÙ
                    document.getElementById('inp-phone').disabled = true;
                    document.getElementById('phone-lock-hint').style.display = 'block';
                } else {
                    // *** Ù‡Ù†Ø§ Ø§Ù„Ø­Ù„ Ù„Ù„Ù…Ø´ÙƒÙ„Ø© ***
                    // Ù„Ø§ Ù†Ø¸Ù‡Ø± ØªÙ†Ø¨ÙŠÙ‡ØŒ Ø¨Ù„ Ù†ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù„ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                    document.getElementById('inp-email').value = user.email;
                    document.getElementById('inp-phone').disabled = false; // Ù†ÙØªØ­ Ø§Ù„Ù‡Ø§ØªÙ Ù„Ø£ÙˆÙ„ Ù…Ø±Ø©
                    document.getElementById('phone-lock-hint').style.display = 'none';
                    openEditModal(); 
                }
            } else {
                document.getElementById('guest-view').style.display = 'block';
                document.getElementById('user-view').style.display = 'none';
            }
        });

        function showProfile(user, data) {
            document.getElementById('guest-view').style.display = 'none';
            document.getElementById('user-view').style.display = 'block';

            document.getElementById('main-name').innerText = (data.firstName || "User") + " " + (data.secondName || "");
            document.getElementById('main-avatar').src = user.photoURL || "https://via.placeholder.com/150";

            // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø­Ù‚ÙˆÙ„ ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ©
            document.getElementById('inp-fname').value = data.firstName || "";
            document.getElementById('inp-sname').value = data.secondName || "";
            document.getElementById('inp-phone').value = data.phone || "";
            document.getElementById('inp-email').value = user.email;
            document.getElementById('inp-city').value = data.city || "";
            document.getElementById('inp-street').value = data.street || "";
        }

        window.openEditModal = () => document.getElementById('edit-modal').classList.add('open');
        window.closeEditModal = () => document.getElementById('edit-modal').classList.remove('open');

        window.saveData = async () => {
            const fname = document.getElementById('inp-fname').value.trim();
            const sname = document.getElementById('inp-sname').value.trim();
            const phone = document.getElementById('inp-phone').value.trim();
            const city = document.getElementById('inp-city').value.trim();
            const street = document.getElementById('inp-street').value.trim();

            if(!fname || !phone) {
                alert("ÙŠØ±Ø¬Ù‰ ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø§Ø³Ù… ÙˆØ±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ");
                return;
            }

            const btn = document.querySelector('.save-btn');
            btn.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...";

            try {
                // Ø§Ø³ØªØ®Ø¯Ø§Ù… setDoc Ù…Ø¹ merge Ù„ØªØ­Ø¯ÙŠØ« Ø£Ùˆ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                await setDoc(doc(db, "users", currentUser.uid), {
                    firstName: fname,
                    secondName: sname,
                    phone: phone,
                    email: currentUser.email,
                    city: city,
                    street: street
                }, { merge: true });

                // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ÙÙˆØ±Ø§Ù‹
                document.getElementById('main-name').innerText = fname + " " + sname;
                
                // Ù‚ÙÙ„ Ø§Ù„Ù‡Ø§ØªÙ Ø¨Ø¹Ø¯ Ø£ÙˆÙ„ Ø­ÙØ¸ Ù†Ø§Ø¬Ø­
                document.getElementById('inp-phone').disabled = true;
                document.getElementById('phone-lock-hint').style.display = 'block';

                closeEditModal();
                // Ø¥Ø¸Ù‡Ø§Ø± ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ø­Ø§Ù„ ÙƒØ§Ù† Ø¬Ø¯ÙŠØ¯Ø§Ù‹
                document.getElementById('guest-view').style.display = 'none';
                document.getElementById('user-view').style.display = 'block';

            } catch (error) {
                console.error(error);
                alert("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸");
            }
            btn.innerText = "Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª";
        };

        document.getElementById('login-btn').addEventListener('click', () => signInWithPopup(auth, provider));
        document.getElementById('logout-btn').addEventListener('click', () => signOut(auth).then(() => location.reload()));
    </script>
</body>
</html>
