<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap');
        
        :root {
            --bg-color: #FAFAFA; --card-bg: #FFFFFF;
            --text-main: #1D1D1D; --text-sub: #888888;
            --accent-color: #008489;
            --border-color: #F0F0F0;
            --error-color: #E53935;
        }

        body.dark-mode {
            --bg-color: #121212; --card-bg: #1E1E1E;
            --text-main: #FFFFFF; --text-sub: #AAAAAA;
            --border-color: #333;
        }

        * { box-sizing: border-box; transition: 0.3s; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Cairo', sans-serif; margin: 0; background: var(--bg-color); color: var(--text-main); padding-bottom: 90px; }

        .container { max-width: 500px; margin: 0 auto; padding: 20px; }

        /* Ø§Ù„Ù‡ÙŠØ¯Ø± ÙˆØ§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ */
        header { text-align: center; margin-top: 20px; margin-bottom: 30px; }
        .page-title { font-weight: 800; font-size: 20px; }
        .profile-header { text-align: center; margin-bottom: 40px; }
        .avatar-box { position: relative; width: 100px; height: 100px; margin: 0 auto 15px; }
        .profile-img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; border: 3px solid white; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .edit-icon-badge { position: absolute; bottom: 0; right: 0; background: var(--accent-color); color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 2px solid white; cursor: pointer; }
        .user-name { font-size: 22px; font-weight: 800; margin: 0; }
        .user-role { font-size: 14px; color: var(--text-sub); margin-top: 5px; }

        /* Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© */
        .menu-list { display: flex; flex-direction: column; gap: 15px; }
        .menu-item { background: var(--card-bg); padding: 15px 20px; border-radius: 15px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 2px 10px rgba(0,0,0,0.03); cursor: pointer; }
        .item-left { display: flex; align-items: center; gap: 15px; }
        .item-icon { width: 40px; height: 40px; border-radius: 10px; background: rgba(0, 132, 137, 0.1); color: var(--accent-color); display: flex; align-items: center; justify-content: center; }
        .item-text { font-weight: 700; font-size: 15px; }
        
        .logout-btn { background: var(--accent-color); color: white; width: 100%; padding: 18px; border-radius: 15px; border: none; font-weight: bold; font-size: 16px; margin-top: 30px; cursor: pointer; }

        /* Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ */
        .edit-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-color); z-index: 2000; padding: 20px; overflow-y: auto; transform: translateY(100%); transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1); }
        .edit-modal.open { transform: translateY(0); }
        .modal-nav { display: flex; align-items: center; margin-bottom: 30px; }
        .back-btn { width: 40px; height: 40px; background: var(--card-bg); border-radius: 10px; display: flex; align-items: center; justify-content: center; cursor: pointer; }

        .form-group { margin-bottom: 20px; }
        .label { display: block; font-size: 13px; font-weight: 700; color: var(--text-sub); margin-bottom: 8px; }
        .input-field { width: 100%; padding: 16px; border-radius: 12px; border: 1px solid var(--border-color); background: var(--card-bg); color: var(--text-main); font-family: 'Cairo'; font-weight: 600; font-size: 15px; }
        .input-field:focus { outline: 2px solid var(--accent-color); border-color: transparent; }
        
        /* Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø±Ø§Ø¯ÙŠÙˆ (Ù†Ø¹Ù…/Ù„Ø§) */
        .radio-group { display: flex; gap: 20px; margin-top: 5px; }
        .radio-label { display: flex; align-items: center; gap: 8px; font-weight: 600; cursor: pointer; }
        .radio-label input { accent-color: var(--accent-color); transform: scale(1.2); }

        .error-msg { color: var(--error-color); font-size: 12px; margin-top: 5px; display: none; font-weight: bold; }
        .input-field.error { border-color: var(--error-color); background: rgba(229, 57, 53, 0.05); }
        .input-field:disabled { background: #EFEFEF; color: #999; cursor: not-allowed; }
        .lock-note { font-size: 11px; color: var(--error-color); margin-top: 5px; }

        .save-btn { background: var(--accent-color); color: white; width: 100%; padding: 18px; border-radius: 50px; border: none; font-weight: bold; font-size: 16px; margin-top: 20px; cursor: pointer; box-shadow: 0 10px 20px rgba(0, 132, 137, 0.2); }

        /* ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¶ÙŠÙ */
        .guest-view { text-align: center; padding: 60px 20px; display: none; }
        .google-btn { background: white; color: #333; padding: 12px 30px; border-radius: 50px; font-weight: bold; border: 1px solid #ddd; display: inline-flex; align-items: center; gap: 10px; cursor: pointer; margin-top: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }

        /* Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³ÙÙ„ÙŠØ© */
        .floating-nav { position: fixed; bottom: 20px; left: 20px; right: 20px; background: white; height: 70px; border-radius: 25px; display: flex; justify-content: space-around; align-items: center; box-shadow: 0 10px 40px rgba(0,0,0,0.1); z-index: 900; }
        .nav-link svg { width: 26px; height: 26px; stroke: #999; fill: none; stroke-width: 2; }
        .nav-link.active svg { stroke: var(--accent-color); }
        @media (min-width: 769px) { .floating-nav { display: none; } }
    </style>
</head>
<body>

    <div id="user-view" style="display: none;">
        <header><div class="page-title">Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</div></header>

        <div class="container">
            <div class="profile-header">
                <div class="avatar-box">
                    <img id="main-avatar" src="" class="profile-img">
                    <div class="edit-icon-badge" onclick="openEditModal()">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                    </div>
                </div>
                <h2 id="main-name" class="user-name">...</h2>
                <div class="user-role">Ø¹Ù…ÙŠÙ„ Ù…Ù…ÙŠØ²</div>
            </div>

            <div class="menu-list">
                <div class="menu-item" onclick="openEditModal()">
                    <div class="item-left">
                        <div class="item-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg></div>
                        <span class="item-text">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</span>
                    </div>
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#ccc" stroke-width="2"><polyline points="15 18 9 12 15 6"></polyline></svg>
                </div>

                <div class="menu-item" onclick="alert('ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¯Ø¹Ù…: support@wusooly.com')">
                    <div class="item-left">
                        <div class="item-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="5" y="2" width="14" height="20" rx="2" ry="2"></rect><line x1="12" y1="18" x2="12.01" y2="18"></line></svg></div>
                        <span class="item-text">ØªØºÙŠÙŠØ± Ø§Ù„Ø±Ù‚Ù… / Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„</span>
                    </div>
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#ccc" stroke-width="2"><polyline points="15 18 9 12 15 6"></polyline></svg>
                </div>
            </div>

            <button class="logout-btn" id="logout-btn">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
        </div>
    </div>

    <div id="guest-view" class="guest-view">
        <span style="font-size:60px;">ğŸ”’</span>
        <h2>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ø·Ù„ÙˆØ¨</h2>
        <button id="login-btn" class="google-btn">
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="20">
            Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Google
        </button>
    </div>

    <div id="edit-modal" class="edit-modal">
        <div class="container">
            <div class="modal-nav">
                <div class="back-btn" onclick="closeEditModal()">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"></polyline></svg>
                </div>
                <h3 style="flex-grow:1; text-align:center;">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h3>
                <div style="width:40px;"></div>
            </div>

            <div class="form-group">
                <label class="label">Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø£ÙˆÙ„ (Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©)</label>
                <input type="text" id="inp-fname" class="input-field" placeholder="Ù…Ø«Ù„Ø§Ù‹: Ù…Ø­Ù…Ø¯">
                <div id="err-fname" class="error-msg">ÙŠØ±Ø¬Ù‰ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø£Ø­Ø±Ù Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© ÙÙ‚Ø·</div>
            </div>
            <div class="form-group">
                <label class="label">Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ø¦Ù„Ø© (Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©)</label>
                <input type="text" id="inp-sname" class="input-field" placeholder="Ù…Ø«Ù„Ø§Ù‹: Ø£Ø­Ù…Ø¯">
                <div id="err-sname" class="error-msg">ÙŠØ±Ø¬Ù‰ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø£Ø­Ø±Ù Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© ÙÙ‚Ø·</div>
            </div>

            <div class="form-group">
                <label class="label">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
                <input type="tel" id="inp-phone" class="input-field" placeholder="05xxxxxxxx" dir="ltr" style="text-align:right;">
                <div id="err-phone" class="error-msg">Ø§Ù„Ø±Ù‚Ù… ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ¨Ø¯Ø£ Ø¨Ù€ 05 (10 Ø®Ø§Ù†Ø§Øª) Ø£Ùˆ 5 (9 Ø®Ø§Ù†Ø§Øª)</div>
                <div id="phone-lock-hint" class="lock-note" style="display:none;">ğŸ”’ Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØºÙŠÙŠØ± Ø§Ù„Ø±Ù‚Ù… Ø¥Ù„Ø§ Ø¨Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</div>
            </div>

            <div class="form-group">
                <label class="label">Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</label>
                <select id="inp-region" class="input-field" onchange="updateCities()">
                    <option value="" disabled selected>Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</option>
                    <option value="westbank">Ø§Ù„Ø¶ÙØ© Ø§Ù„ØºØ±Ø¨ÙŠØ©</option>
                    <option value="interior">Ø§Ù„Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ø­ØªÙ„</option>
                </select>
            </div>

            <div class="form-group" id="city-group" style="display:none;">
                <label class="label">Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</label>
                <select id="inp-city" class="input-field" onchange="showVillageQuestion()">
                    <option value="" disabled selected>Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</option>
                </select>
            </div>

            <div class="form-group" id="village-question-group" style="display:none;">
                <label class="label">Ù‡Ù„ ØªØ³ÙƒÙ† ÙÙŠ Ù‚Ø±ÙŠØ©/Ø¨Ù„Ø¯Ø© ØªØ§Ø¨Ø¹Ø© Ù„Ù„Ù…Ø¯ÙŠÙ†Ø©ØŸ</label>
                <div class="radio-group">
                    <label class="radio-label">
                        <input type="radio" name="is_village" value="yes" onchange="toggleVillageInput()"> Ù†Ø¹Ù…
                    </label>
                    <label class="radio-label">
                        <input type="radio" name="is_village" value="no" onchange="toggleVillageInput()" checked> Ù„Ø§ (Ø£Ø³ÙƒÙ† ÙÙŠ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©)
                    </label>
                </div>
            </div>

            <div class="form-group" id="village-input-group" style="display:none;">
                <label class="label">Ø§Ø³Ù… Ø§Ù„Ù‚Ø±ÙŠØ© / Ø§Ù„Ø¨Ù„Ø¯Ø©</label>
                <input type="text" id="inp-village-text" class="input-field" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù‚Ø±ÙŠØ©...">
            </div>

            <div class="form-group">
                <label class="label">Ø§Ù„Ø´Ø§Ø±Ø¹ / Ù…Ø¹Ù„Ù… Ù‚Ø±ÙŠØ¨</label>
                <input type="text" id="inp-street" class="input-field">
            </div>

            <button class="save-btn" onclick="saveData()">Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</button>
        </div>
    </div>

    <div class="floating-nav">
        <a href="index.html" class="nav-link"><svg viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg></a>
        <a href="cart.html" class="nav-link"><svg viewBox="0 0 24 24"><circle cx="9" cy="21" r="1"></circle><circle cx="20" cy="21" r="1"></circle><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path></svg></a>
        <a href="#" class="nav-link active"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg></a>
    </div>

    <script>if (localStorage.getItem('theme') === 'dark') document.body.classList.add('dark-mode');</script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signOut, onAuthStateChanged, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBa0RwEcbVqWYAKeUFeZy2IDihaxUxtNKY",
            authDomain: "wusooly-1906b.firebaseapp.com",
            projectId: "wusooly-1906b",
            storageBucket: "wusooly-1906b.firebasestorage.app",
            messagingSenderId: "95836343161",
            appId: "1:95836343161:web:73ae3faaca406c0bf7fda8",
            measurementId: "G-2704R4YR1M"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();
        
        let currentUser = null;

        const cities = {
            westbank: ["Ø±Ø§Ù… Ø§Ù„Ù„Ù‡", "Ù†Ø§Ø¨Ù„Ø³", "Ø§Ù„Ø®Ù„ÙŠÙ„", "Ø¬Ù†ÙŠÙ†", "Ø·ÙˆÙ„ÙƒØ±Ù…", "Ø¨ÙŠØª Ù„Ø­Ù…", "Ù‚Ù„Ù‚ÙŠÙ„ÙŠØ©", "Ø³Ù„ÙÙŠØª", "Ø£Ø±ÙŠØ­Ø§", "Ø·ÙˆØ¨Ø§Ø³", "Ø§Ù„Ù‚Ø¯Ø³"],
            interior: ["Ø§Ù„Ù†Ø§ØµØ±Ø©", "Ø­ÙŠÙØ§", "ÙŠØ§ÙØ§", "Ø¹ÙƒØ§", "Ø£Ù… Ø§Ù„ÙØ­Ù…", "Ø§Ù„Ø·ÙŠØ¨Ø©", "Ø³Ø®Ù†ÙŠÙ†", "Ø¨Ø§Ù‚Ø© Ø§Ù„ØºØ±Ø¨ÙŠØ©", "Ø±Ù‡Ø·", "Ø§Ù„Ù„Ø¯", "Ø§Ù„Ø±Ù…Ù„Ø©"]
        };

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                const userDoc = await getDoc(doc(db, "users", user.uid));
                
                if (userDoc.exists()) {
                    const data = userDoc.data();
                    showProfile(user, data);
                    
                    const phoneInput = document.getElementById('inp-phone');
                    phoneInput.value = data.phone;
                    phoneInput.disabled = true;
                    document.getElementById('phone-lock-hint').style.display = 'block';

                    // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
                    if(data.region) {
                        document.getElementById('inp-region').value = data.region;
                        updateCities(); 
                        document.getElementById('inp-city').value = data.city;
                        
                        // Ø¥Ø¸Ù‡Ø§Ø± Ø³Ø¤Ø§Ù„ Ø§Ù„Ù‚Ø±ÙŠØ©
                        document.getElementById('village-question-group').style.display = 'block';
                        
                        if (data.village && data.village !== "Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ù†ÙØ³Ù‡Ø§") {
                            // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙŠØ³ÙƒÙ† ÙÙŠ Ù‚Ø±ÙŠØ©
                            document.querySelector('input[name="is_village"][value="yes"]').checked = true;
                            document.getElementById('village-input-group').style.display = 'block';
                            document.getElementById('inp-village-text').value = data.village;
                        } else {
                            // ÙŠØ³ÙƒÙ† ÙÙŠ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©
                            document.querySelector('input[name="is_village"][value="no"]').checked = true;
                            document.getElementById('village-input-group').style.display = 'none';
                        }
                    }
                } else {
                    document.getElementById('inp-phone').disabled = false;
                    document.getElementById('phone-lock-hint').style.display = 'none';
                    openEditModal(); 
                }
            } else {
                document.getElementById('guest-view').style.display = 'block';
                document.getElementById('user-view').style.display = 'none';
            }
        });

        function showProfile(user, data) {
            document.getElementById('guest-view').style.display = 'none';
            document.getElementById('user-view').style.display = 'block';
            document.getElementById('main-name').innerText = (data.firstName || "Ù…Ø³ØªØ®Ø¯Ù…") + " " + (data.secondName || "");
            document.getElementById('main-avatar').src = user.photoURL || "https://via.placeholder.com/150";

            document.getElementById('inp-fname').value = data.firstName || "";
            document.getElementById('inp-sname').value = data.secondName || "";
            document.getElementById('inp-street').value = data.street || "";
        }

        window.updateCities = () => {
            const region = document.getElementById('inp-region').value;
            const citySelect = document.getElementById('inp-city');
            const cityGroup = document.getElementById('city-group');

            citySelect.innerHTML = '<option value="" disabled selected>Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</option>';
            document.getElementById('village-question-group').style.display = 'none';
            document.getElementById('village-input-group').style.display = 'none';

            if (cities[region]) {
                cities[region].forEach(city => {
                    const option = document.createElement('option');
                    option.value = city;
                    option.innerText = city;
                    citySelect.appendChild(option);
                });
                cityGroup.style.display = 'block';
            } else {
                cityGroup.style.display = 'none';
            }
        };

        window.showVillageQuestion = () => {
            document.getElementById('village-question-group').style.display = 'block';
        };

        window.toggleVillageInput = () => {
            const isYes = document.querySelector('input[name="is_village"]:checked').value === 'yes';
            const inputGroup = document.getElementById('village-input-group');
            inputGroup.style.display = isYes ? 'block' : 'none';
            if(!isYes) document.getElementById('inp-village-text').value = ""; // Ù…Ø³Ø­ Ø§Ù„Ù†Øµ
        };

        window.openEditModal = () => document.getElementById('edit-modal').classList.add('open');
        window.closeEditModal = () => document.getElementById('edit-modal').classList.remove('open');

        window.saveData = async () => {
            document.querySelectorAll('.error-msg').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.input-field').forEach(el => el.classList.remove('error'));

            const fname = document.getElementById('inp-fname').value.trim();
            const sname = document.getElementById('inp-sname').value.trim();
            const phone = document.getElementById('inp-phone').value.trim();
            const region = document.getElementById('inp-region').value;
            const city = document.getElementById('inp-city').value;
            const street = document.getElementById('inp-street').value.trim();
            
            // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ù‚Ø±ÙŠØ©
            const isVillage = document.querySelector('input[name="is_village"]:checked').value === 'yes';
            const villageName = isVillage ? document.getElementById('inp-village-text').value.trim() : "Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ù†ÙØ³Ù‡Ø§";

            let isValid = true;

            const arabicRegex = /^[\u0621-\u064A ]+$/;
            if (!arabicRegex.test(fname)) { showError('inp-fname', 'err-fname'); isValid = false; }
            if (!arabicRegex.test(sname)) { showError('inp-sname', 'err-sname'); isValid = false; }

            const isValidPhone = (phone.startsWith('05') && phone.length === 10 && /^\d+$/.test(phone)) ||
                                 (phone.startsWith('5') && phone.length === 9 && /^\d+$/.test(phone));

            if (!isValidPhone) { showError('inp-phone', 'err-phone'); isValid = false; }

            if (!region || !city) {
                alert("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù†Ø·Ù‚Ø© ÙˆØ§Ù„Ù…Ø¯ÙŠÙ†Ø©");
                isValid = false;
            }

            if (isVillage && !villageName) {
                alert("ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø§Ø³Ù… Ø§Ù„Ù‚Ø±ÙŠØ©");
                isValid = false;
            }

            if (!isValid) return;

            const btn = document.querySelector('.save-btn');
            btn.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...";

            try {
                await setDoc(doc(db, "users", currentUser.uid), {
                    firstName: fname,
                    secondName: sname,
                    phone: phone,
                    email: currentUser.email,
                    region: region,
                    city: city,
                    village: villageName,
                    street: street
                }, { merge: true });

                document.getElementById('main-name').innerText = fname + " " + sname;
                document.getElementById('inp-phone').disabled = true;
                document.getElementById('phone-lock-hint').style.display = 'block';

                closeEditModal();
                alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­ âœ…");
            } catch (error) {
                console.error(error);
                alert("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸");
            }
            btn.innerText = "Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª";
        };

        function showError(inputId, errorId) {
            document.getElementById(inputId).classList.add('error');
            document.getElementById(errorId).style.display = 'block';
        }

        document.getElementById('login-btn').addEventListener('click', () => signInWithPopup(auth, provider));
        document.getElementById('logout-btn').addEventListener('click', () => signOut(auth).then(() => location.reload()));
    </script>
</body>
</html>
