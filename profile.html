<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø­Ø³Ø§Ø¨ÙŠ - Wusooly</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap');
        
        :root {
            --bg-color: #F8F9FA; --header-bg: #FFFFFF; --text-main: #333; --text-sub: #666;
            --accent-color: #0056b3; --card-bg: #FFFFFF; --input-bg: #F2F2F7;
            --radius-lg: 20px;
        }

        body.dark-mode {
            --bg-color: #121212; --header-bg: #1C1C1E; --text-main: #FFFFFF; --text-sub: #A1A1A1;
            --accent-color: #4dabf7; --card-bg: #2C2C2E; --input-bg: #3A3A3C;
        }

        * { box-sizing: border-box; transition: 0.3s; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Cairo', sans-serif; margin: 0; background-color: var(--bg-color); color: var(--text-main); padding-bottom: 100px; overflow-x: hidden; }

        header { padding: 15px; background: var(--header-bg); position: sticky; top: 0; z-index: 100; text-align: center; box-shadow: 0 1px 0 rgba(0,0,0,0.05); }
        .logo-img { height: 28px; }

        .container { max-width: 600px; margin: 0 auto; padding: 20px; }
        
        .profile-card, .guest-card { background: var(--card-bg); border-radius: var(--radius-lg); padding: 40px 20px; text-align: center; box-shadow: 0 4px 20px rgba(0,0,0,0.03); margin-top: 20px; display: none; }
        .avatar-wrapper { width: 100px; height: 100px; margin: 0 auto 20px; border-radius: 50%; padding: 3px; border: 2px dashed var(--accent-color); }
        .profile-img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; }
        
        .info-row { text-align: right; background: var(--input-bg); padding: 15px; border-radius: 12px; margin-bottom: 10px; font-size: 14px; }
        .info-label { font-weight: bold; color: var(--accent-color); display: block; margin-bottom: 5px; }

        .action-btn { background: var(--input-bg); color: #ff4747; width: 100%; padding: 15px; border-radius: 15px; border: none; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .admin-btn { background: var(--accent-color); color: #fff; margin-bottom: 10px; }
        .google-btn { background: #fff; color: #333; border: 1px solid #ddd; padding: 12px 25px; border-radius: 50px; font-weight: bold; margin-top: 20px; display: inline-flex; align-items: center; gap: 10px; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        
        /* --- ØªØµÙ…ÙŠÙ… Ù†Ø§ÙØ°Ø© Ø§Ø³ØªÙƒÙ…Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Modal) --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 9999;
            display: none; justify-content: center; align-items: center; padding: 20px;
        }
        .modal-content {
            background: var(--card-bg); width: 100%; max-width: 500px;
            border-radius: 20px; padding: 30px 20px;
            max-height: 90vh; overflow-y: auto; text-align: center;
        }
        .modal-title { font-size: 18px; font-weight: 800; margin-bottom: 20px; color: var(--accent-color); }
        .form-group { margin-bottom: 15px; text-align: right; }
        .form-input { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #ddd; background: var(--input-bg); color: var(--text-main); font-family: 'Cairo'; }
        
        .checkbox-container { display: flex; align-items: center; gap: 10px; margin: 20px 0; font-size: 13px; text-align: right; }
        .save-btn { background: var(--accent-color); color: white; width: 100%; padding: 15px; border-radius: 50px; border: none; font-weight: bold; cursor: pointer; opacity: 0.5; pointer-events: none; transition: 0.3s; }
        .save-btn.active { opacity: 1; pointer-events: all; }

        .floating-nav { position: fixed; bottom: 20px; left: 20px; right: 20px; background: #fff; height: 70px; border-radius: 25px; display: flex; justify-content: space-around; align-items: center; box-shadow: 0 10px 40px rgba(0,0,0,0.1); z-index: 999; }
        .nav-link svg { width: 26px; height: 26px; stroke: #999; fill: none; stroke-width: 2; }
        .nav-link.active svg { stroke: var(--accent-color); }
        body.dark-mode .floating-nav { background: #1C1C1E; }
    </style>
</head>
<body>

    <header>
        <a href="index.html"><img id="app-logo" src="" class="logo-img"></a>
    </header>

    <div class="container">
        <h2 style="margin-bottom: 20px; font-weight: 800; text-align: center;">Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</h2>
        <div id="loading" style="text-align: center; color: var(--text-sub);">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>

        <div id="user-profile" class="profile-card">
            <div class="avatar-wrapper"><img id="user-img" src="" class="profile-img"></div>
            <h3 id="display-name" style="margin:0 0 5px;">User</h3>
            <p id="user-email" style="color:var(--text-sub); margin:0 0 20px; font-size:13px;">email</p>

            <div class="info-row"><span class="info-label">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ:</span> <span id="view-phone">...</span></div>
            <div class="info-row"><span class="info-label">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</span> <span id="view-address">...</span></div>

            <button class="action-btn admin-btn" onclick="window.location.href='admin.html'">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</button>
            <button class="action-btn" id="logout-btn">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
        </div>

        <div id="guest-profile" class="guest-card">
            <span style="font-size:50px;">ğŸ”’</span>
            <h3>ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h3>
            <button id="login-btn" class="google-btn">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="20">
                Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Google
            </button>
        </div>
    </div>

    <div id="complete-profile-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-title">Ø§Ø³ØªÙƒÙ…Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ğŸ“</div>
            <p style="font-size:13px; color:var(--text-sub); margin-bottom:20px;">ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ§Ù„ÙŠØ© Ù„Ø¥ØªÙ…Ø§Ù… Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ³Ø¬ÙŠÙ„.</p>
            
            <div class="form-group"><input type="text" id="inp-first" class="form-input" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø£ÙˆÙ„"></div>
            <div class="form-group"><input type="text" id="inp-second" class="form-input" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ø§Ù†ÙŠ"></div>
            <div class="form-group"><input type="tel" id="inp-phone" class="form-input" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ (Ù…Ø«Ø§Ù„: 059xxxxxxx)"></div>
            <div class="form-group"><input type="text" id="inp-city" class="form-input" placeholder="Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© / Ø§Ù„Ù‚Ø±ÙŠØ©"></div>
            <div class="form-group"><input type="text" id="inp-street" class="form-input" placeholder="Ø§Ù„Ø´Ø§Ø±Ø¹ / Ù…Ø¹Ù„Ù… Ù‚Ø±ÙŠØ¨"></div>

            <div class="checkbox-container">
                <input type="checkbox" id="terms-check" onchange="toggleSaveBtn()">
                <label for="terms-check">Ø£ÙˆØ§ÙÙ‚ Ø¹Ù„Ù‰ <span style="color:var(--accent-color);text-decoration:underline;">Ø´Ø±ÙˆØ· Ø§Ù„Ø®ØµÙˆØµÙŠØ© ÙˆØ§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…</span> Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„ØªØ·Ø¨ÙŠÙ‚.</label>
            </div>

            <button id="save-profile-btn" class="save-btn" onclick="saveUserProfile()">Ø­ÙØ¸ ÙˆÙ…ØªØ§Ø¨Ø¹Ø©</button>
        </div>
    </div>

    <div class="floating-nav">
        <a href="index.html" class="nav-link"><svg viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg></a>
        <a href="cart.html" class="nav-link"><svg viewBox="0 0 24 24"><circle cx="9" cy="21" r="1"></circle><circle cx="20" cy="21" r="1"></circle><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path></svg></a>
        <a href="#" class="nav-link active"><svg viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg></a>
    </div>

    <script>
        const imageConfig = { 'app-logo': { light: "https://raw.githubusercontent.com/yazankmail/home/refs/heads/main/%D9%A2%D9%A0%D9%A2%D9%A6%D9%A0%D9%A1%D9%A3%D9%A1_%D9%A2%D9%A1%D9%A4%D9%A7%D9%A3%D9%A5.png", dark: "https://raw.githubusercontent.com/yazankmail/home/refs/heads/main/%D9%A2%D9%A0%D9%A2%D9%A6%D9%A0%D9%A1%D9%A3%D9%A1_%D9%A2%D9%A1%D9%A4%D9%A7%D9%A1%D9%A4.png" } };
        function updateImages(isDark) { document.getElementById('app-logo').src = isDark ? imageConfig['app-logo'].dark : imageConfig['app-logo'].light; }
        if (localStorage.getItem('theme') === 'dark') document.body.classList.add('dark-mode');
        updateImages(document.body.classList.contains('dark-mode'));
    </script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signOut, onAuthStateChanged, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBa0RwEcbVqWYAKeUFeZy2IDihaxUxtNKY",
            authDomain: "wusooly-1906b.firebaseapp.com",
            projectId: "wusooly-1906b",
            storageBucket: "wusooly-1906b.firebasestorage.app",
            messagingSenderId: "95836343161",
            appId: "1:95836343161:web:73ae3faaca406c0bf7fda8",
            measurementId: "G-2704R4YR1M"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();
        
        let currentUser = null; // Ù„ØªØ®Ø²ÙŠÙ† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ

        // 1. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„
        onAuthStateChanged(auth, async (user) => {
            document.getElementById('loading').style.display = 'none';
            if (user) {
                currentUser = user;
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© ÙÙŠ Firestore
                const userDoc = await getDoc(doc(db, "users", user.uid));
                
                if (userDoc.exists()) {
                    // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„ ÙˆÙ„Ø¯ÙŠÙ‡ Ø¨ÙŠØ§Ù†Ø§Øª -> Ø¹Ø±Ø¶ Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„
                    showUserProfile(user, userDoc.data());
                } else {
                    // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯ Ø£Ùˆ Ù„Ù… ÙŠÙƒÙ…Ù„ Ø¨ÙŠØ§Ù†Ø§ØªÙ‡ -> Ø¹Ø±Ø¶ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¥Ø¬Ø¨Ø§Ø±ÙŠØ©
                    document.getElementById('complete-profile-modal').style.display = 'flex';
                }
            } else {
                // ØºÙŠØ± Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„
                document.getElementById('user-profile').style.display = 'none';
                document.getElementById('guest-profile').style.display = 'block';
            }
        });

        // 2. Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„
        function showUserProfile(user, dbData) {
            document.getElementById('guest-profile').style.display = 'none';
            document.getElementById('complete-profile-modal').style.display = 'none'; // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù†Ø§ÙØ°Ø©
            document.getElementById('user-profile').style.display = 'block';

            document.getElementById('display-name').innerText = dbData.firstName + " " + dbData.secondName;
            document.getElementById('user-email').innerText = user.email;
            document.getElementById('user-img').src = user.photoURL || "https://via.placeholder.com/100";
            
            document.getElementById('view-phone').innerText = dbData.phone;
            document.getElementById('view-address').innerText = dbData.city + " - " + dbData.street;
        }

        // 3. ØªÙØ¹ÙŠÙ„ Ø²Ø± Ø§Ù„Ø­ÙØ¸ Ø¹Ù†Ø¯ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø±ÙˆØ·
        window.toggleSaveBtn = function() {
            const isChecked = document.getElementById('terms-check').checked;
            const btn = document.getElementById('save-profile-btn');
            if(isChecked) btn.classList.add('active');
            else btn.classList.remove('active');
        }

        // 4. Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Firestore
        window.saveUserProfile = async function() {
            const fName = document.getElementById('inp-first').value.trim();
            const sName = document.getElementById('inp-second').value.trim();
            const phone = document.getElementById('inp-phone').value.trim();
            const city = document.getElementById('inp-city').value.trim();
            const street = document.getElementById('inp-street').value.trim();

            if(!fName || !sName || !phone || !city || !street) {
                alert("ÙŠØ±Ø¬Ù‰ ØªØ¹Ø¨Ø¦Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©");
                return;
            }

            const btn = document.getElementById('save-profile-btn');
            btn.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...";

            try {
                // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ ÙƒÙˆÙ„ÙƒØ´Ù† "users"
                const userData = {
                    firstName: fName,
                    secondName: sName,
                    phone: phone,
                    city: city,
                    street: street,
                    email: currentUser.email,
                    createdAt: Date.now(),
                    agreedToTerms: true
                };

                await setDoc(doc(db, "users", currentUser.uid), userData);
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ÙÙˆØ±Ø§Ù‹
                showUserProfile(currentUser, userData);

            } catch (error) {
                console.error(error);
                alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸");
                btn.innerText = "Ø­ÙØ¸ ÙˆÙ…ØªØ§Ø¨Ø¹Ø©";
            }
        }

        // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
        document.getElementById('login-btn').addEventListener('click', () => {
            signInWithPopup(auth, provider).catch((error) => alert(error.message));
        });

        // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
        document.getElementById('logout-btn').addEventListener('click', () => {
            signOut(auth).then(() => location.reload());
        });
    </script>
</body>
</html>
